<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MailingPro | Enterprise Composer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e',
                        },
                        slate: {
                            850: '#1e293b',
                        }
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02)',
                        'float': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Reset & Base */
        body { background-color: #f3f4f6; -webkit-font-smoothing: antialiased; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        /* Editor Polish */
        #editor { min-height: 400px; outline: none; line-height: 1.75; font-size: 1.05rem; }
        #editor:empty:before { content: attr(placeholder); color: #9ca3af; pointer-events: none; display: block; }
        
        /* Animations */
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Spinner */
        .spinner { width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotate 0.75s linear infinite; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }

        /* Spam Highlight */
        .spam-highlight { background-color: #fee2e2; color: #dc2626; text-decoration: underline; text-decoration-style: wavy; text-decoration-thickness: 2px; padding: 0 2px; border-radius: 2px; }
    </style>
</head>
<body class="h-screen w-full flex items-center justify-center overflow-hidden text-slate-900">

    <!-- Main Layout -->
    <div class="w-full h-full flex flex-col md:h-[96vh] md:w-[96vw] md:max-w-6xl bg-white md:rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        
        <!-- Header -->
        <header class="bg-white border-b border-slate-100 px-6 py-3 flex justify-between items-center shrink-0 h-16 z-20">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-slate-900 text-white flex items-center justify-center shadow-md">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </div>
                <div class="flex flex-col">
                    <span class="font-bold text-slate-900 leading-none tracking-tight text-base">MailingPro</span>
                    <span class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest mt-0.5">Secure Composer</span>
                </div>
            </div>
            <button onclick="openSettings()" class="w-9 h-9 rounded-lg hover:bg-slate-50 flex items-center justify-center text-slate-400 hover:text-slate-700 transition-colors">
                <i class="fa-solid fa-gear"></i>
            </button>
        </header>

        <!-- Content Scroll Area -->
        <div class="flex-1 overflow-y-auto bg-white relative">
            <div class="max-w-4xl mx-auto px-6 py-8 pb-32">
                
                <!-- SECTION 1: Sender Details -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-5 mb-8">
                    
                    <!-- Name -->
                    <div class="md:col-span-4">
                        <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-2 ml-1">From Name</label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-regular fa-user text-slate-400 group-focus-within:text-brand-600 transition-colors"></i>
                            </div>
                            <input type="text" id="senderName" class="w-full pl-9 pr-4 py-2.5 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-800 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition-all placeholder-slate-400 shadow-sm" placeholder="Your Name">
                        </div>
                    </div>

                    <!-- Username -->
                    <div class="md:col-span-5">
                        <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-2 ml-1">Username</label>
                        <div class="flex rounded-lg shadow-sm border border-slate-200 overflow-hidden focus-within:border-brand-500 focus-within:ring-1 focus-within:ring-brand-500 transition-all">
                            <div class="pl-3 py-2.5 flex items-center bg-white border-r-0 pointer-events-none">
                                <i class="fa-solid fa-at text-slate-400 text-xs"></i>
                            </div>
                            <input type="text" id="senderUsername" class="flex-1 min-w-0 px-2 py-2.5 text-sm font-medium text-slate-800 outline-none placeholder-slate-400 text-right bg-white" placeholder="username">
                            <div class="px-3 py-2.5 bg-slate-50 border-l border-slate-100 text-xs font-semibold text-slate-500 select-none whitespace-nowrap flex items-center">
                                @us.zengrid.cloud
                            </div>
                        </div>
                    </div>

                    <!-- Business -->
                    <div class="md:col-span-3">
                        <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-2 ml-1">Organization</label>
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-regular fa-building text-slate-400 group-focus-within:text-brand-600 transition-colors"></i>
                            </div>
                            <input type="text" id="businessName" class="w-full pl-9 pr-4 py-2.5 bg-white border border-slate-200 rounded-lg text-sm font-medium text-slate-800 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition-all placeholder-slate-400 shadow-sm" placeholder="Company">
                        </div>
                    </div>
                </div>

                <hr class="border-slate-100 mb-6">

                <!-- SECTION 2: Recipient & Subject -->
                <div class="space-y-5">
                    
                    <!-- To -->
                    <div class="relative">
                        <div class="flex items-center justify-between mb-1.5">
                            <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest ml-1">Recipient</label>
                            <div class="flex gap-3">
                                <button onclick="toggleField('ccField')" class="text-[11px] font-bold text-brand-600 hover:text-brand-700 uppercase tracking-widest hover:underline">Cc</button>
                                <button onclick="toggleField('bccField')" class="text-[11px] font-bold text-brand-600 hover:text-brand-700 uppercase tracking-widest hover:underline">Bcc</button>
                            </div>
                        </div>
                        <input type="email" id="recipientEmail" class="w-full px-4 py-3 bg-slate-50 border border-transparent focus:bg-white focus:border-brand-500 focus:ring-1 focus:ring-brand-500 rounded-lg text-slate-900 font-medium placeholder-slate-400 transition-all outline-none" placeholder="recipient@example.com">
                    </div>

                    <!-- Hidden Fields -->
                    <div id="ccField" class="hidden animate-slide-up">
                        <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-1.5 ml-1">Cc</label>
                        <input type="text" id="ccEmails" class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-lg text-sm text-slate-800 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition-all placeholder-slate-400" placeholder="Comma separated emails">
                    </div>
                    <div id="bccField" class="hidden animate-slide-up">
                        <label class="block text-[11px] font-bold text-slate-500 uppercase tracking-widest mb-1.5 ml-1">Bcc</label>
                        <input type="text" id="bccEmails" class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-lg text-sm text-slate-800 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition-all placeholder-slate-400" placeholder="Comma separated emails">
                    </div>

                    <!-- Subject -->
                    <div class="pt-2">
                        <input type="text" id="subject" class="w-full py-2 bg-transparent border-none text-3xl font-bold text-slate-900 placeholder-slate-300 focus:ring-0 outline-none tracking-tight" placeholder="Subject Line">
                    </div>
                </div>

                <!-- SECTION 3: Editor -->
                <div class="mt-6">
                    <div id="editor" contenteditable="true" class="w-full text-slate-700 whitespace-pre-wrap" placeholder="Write your message here..."></div>
                </div>

            </div>
        </div>

        <!-- Floating Command Bar -->
        <div class="absolute bottom-8 left-0 right-0 flex justify-center z-50 pointer-events-none">
            <div class="bg-slate-900 text-white p-1.5 rounded-2xl shadow-float flex items-center gap-2 pointer-events-auto ring-1 ring-white/10 backdrop-blur-xl">
                
                <!-- Formatting -->
                <div class="flex items-center gap-0.5 px-2">
                    <button onmousedown="event.preventDefault()" onclick="execCmd('bold')" class="p-2 rounded-lg hover:bg-white/10 text-slate-300 hover:text-white transition-colors"><i class="fa-solid fa-bold text-sm"></i></button>
                    <button onmousedown="event.preventDefault()" onclick="execCmd('italic')" class="p-2 rounded-lg hover:bg-white/10 text-slate-300 hover:text-white transition-colors"><i class="fa-solid fa-italic text-sm"></i></button>
                    <button onmousedown="event.preventDefault()" onclick="execCmd('underline')" class="p-2 rounded-lg hover:bg-white/10 text-slate-300 hover:text-white transition-colors"><i class="fa-solid fa-underline text-sm"></i></button>
                </div>

                <div class="w-px h-6 bg-white/20"></div>

                <!-- AI Tools -->
                <div class="flex items-center gap-2 px-1">
                    <button onclick="fixSpam()" id="fixSpamBtn" class="hidden flex items-center gap-2 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-white text-xs font-bold uppercase tracking-wide transition-all animate-slide-up shadow-lg shadow-emerald-500/20">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Fix Spam
                    </button>

                    <button onclick="checkSpam()" id="spamBtn" class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-white/10 text-slate-300 hover:text-white text-xs font-bold uppercase tracking-wide transition-all">
                        <i class="fa-solid fa-shield-halved"></i> AI Scan
                    </button>
                </div>

                <div class="w-px h-6 bg-white/20"></div>

                <!-- Send -->
                <button onclick="sendEmail()" id="sendBtn" class="bg-white hover:bg-slate-100 text-slate-900 px-6 py-2.5 rounded-xl font-bold shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                    <span>Send</span>
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>

        <!-- Notifications -->
        <div id="toast" class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur-md text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none z-50 border border-white/10">
            <i id="toastIcon" class="fa-solid fa-circle-check text-emerald-400"></i>
            <span id="toastMsg" class="text-sm font-medium">Message Sent</span>
        </div>

    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-sm overflow-hidden transform scale-95 transition-transform duration-200" id="modalContent">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-slate-800">Settings</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Gemini API Key</label>
                    <input type="password" id="apiKey" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-slate-400 transition-all" placeholder="Enter API Key">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Webhook URL</label>
                    <input type="text" id="webhookUrl" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-slate-400 transition-all">
                </div>
                <button onclick="saveSettings()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-slate-900/10">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- Config ---
        let geminiApiKey = localStorage.getItem('gemini_api_key') || 'AIzaSyD_Pb2GL3ymzlLIU7Pkm3juzal51sDa0uc';
        let n8nWebhookUrl = localStorage.getItem('n8n_webhook_url') || 'https://app.zengrid.cloud/webhook/send-email';
        let currentSpamWords = [];

        document.getElementById('apiKey').value = geminiApiKey;
        document.getElementById('webhookUrl').value = n8nWebhookUrl;

        // --- UI Helpers ---
        function toggleField(id) { document.getElementById(id).classList.toggle('hidden'); }
        function execCmd(cmd) { document.execCommand(cmd, false, null); document.getElementById('editor').focus(); }
        
        function showToast(msg, type='success') {
            const el = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            document.getElementById('toastMsg').textContent = msg;
            icon.className = type === 'success' ? 'fa-solid fa-circle-check text-emerald-400' : 'fa-solid fa-circle-exclamation text-rose-400';
            el.classList.remove('opacity-0', '-translate-y-4');
            setTimeout(() => el.classList.add('opacity-0', '-translate-y-4'), 3000);
        }

        // --- Modal ---
        function openSettings() {
            const m = document.getElementById('settingsModal');
            const c = document.getElementById('modalContent');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); c.classList.remove('scale-95'); c.classList.add('scale-100'); }, 10);
        }
        function closeSettings() {
            const m = document.getElementById('settingsModal');
            const c = document.getElementById('modalContent');
            m.classList.add('opacity-0'); c.classList.remove('scale-100'); c.classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 200);
        }
        function saveSettings() {
            geminiApiKey = document.getElementById('apiKey').value;
            n8nWebhookUrl = document.getElementById('webhookUrl').value;
            localStorage.setItem('gemini_api_key', geminiApiKey);
            localStorage.setItem('n8n_webhook_url', n8nWebhookUrl);
            closeSettings();
            showToast('Settings saved');
        }

        // --- AI Logic ---
        async function checkSpam() {
            if(!geminiApiKey) return openSettings();
            const editor = document.getElementById('editor');
            const btn = document.getElementById('spamBtn');
            const content = editor.innerText;

            if(content.length < 5) return showToast('Content too short', 'error');

            // Clear previous marks
            const temp = document.createElement("div");
            temp.innerHTML = editor.innerHTML;
            temp.querySelectorAll('.spam-highlight').forEach(el => el.replaceWith(el.textContent));
            editor.innerHTML = temp.innerHTML;

            const oldHtml = btn.innerHTML;
            btn.innerHTML = `<div class="spinner border-slate-400 border-t-transparent"></div>`;
            btn.disabled = true;
            document.getElementById('fixSpamBtn').classList.add('hidden');

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Identify spam trigger words in this email. Return ONLY a raw JSON array of strings. If none, return []. Text: "${content}"` }] }] })
                });
                
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                currentSpamWords = JSON.parse(text);

                if(currentSpamWords.length > 0) {
                    let html = editor.innerHTML;
                    [...new Set(currentSpamWords)].sort((a,b) => b.length - a.length).forEach(w => {
                        html = html.replace(new RegExp(`(${w})`, 'gi'), '<span class="spam-highlight">$1</span>');
                    });
                    editor.innerHTML = html;
                    showToast(`${currentSpamWords.length} issues found`, 'error');
                    document.getElementById('fixSpamBtn').classList.remove('hidden');
                } else {
                    showToast('No spam triggers found');
                }
            } catch(e) {
                console.error(e);
                showToast('Scan failed', 'error');
            } finally {
                btn.innerHTML = oldHtml;
                btn.disabled = false;
            }
        }

        async function fixSpam() {
            const btn = document.getElementById('fixSpamBtn');
            const editor = document.getElementById('editor');
            const content = editor.innerText;
            const oldHtml = btn.innerHTML;
            
            btn.innerHTML = `<div class="spinner border-white border-t-transparent"></div>`;
            btn.disabled = true;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Replace these spam triggers: ${JSON.stringify(currentSpamWords)} with professional alternatives in the text. Return ONLY a raw JSON object {original: new}. Text: "${content}"` }] }] })
                });

                const data = await res.json();
                const replacements = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                
                let count = 0;
                document.querySelectorAll('.spam-highlight').forEach(span => {
                    const key = Object.keys(replacements).find(k => k.toLowerCase() === span.innerText.toLowerCase());
                    if(key) { span.replaceWith(replacements[key]); count++; }
                });

                if(count > 0) {
                    showToast(`Fixed ${count} triggers`);
                    btn.classList.add('hidden');
                } else {
                    showToast('Could not auto-fix', 'error');
                }
            } catch(e) {
                showToast('Fix failed', 'error');
            } finally {
                btn.innerHTML = oldHtml;
                btn.disabled = false;
            }
        }

        // --- Send ---
        async function sendEmail() {
            const btn = document.getElementById('sendBtn');
            const username = document.getElementById('senderUsername').value.trim();
            const recipient = document.getElementById('recipientEmail').value.trim();
            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('editor').innerHTML;

            if(!username || !recipient || !subject) return showToast('Fill required fields', 'error');

            const oldHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="spinner border-slate-900 border-t-transparent"></div>`;

            const fd = new FormData();
            fd.append('senderName', document.getElementById('senderName').value);
            fd.append('senderEmail', `${username}@us.zengrid.cloud`);
            fd.append('recipientEmail', recipient);
            fd.append('subject', subject);
            fd.append('bodyContent', body);
            fd.append('businessName', document.getElementById('businessName').value);
            
            const cc = document.getElementById('ccEmails').value;
            if(cc) fd.append('ccEmails', cc);
            const bcc = document.getElementById('bccEmails').value;
            if(bcc) fd.append('bccEmails', bcc);

            try {
                const res = await fetch(n8nWebhookUrl, { method: 'POST', body: fd });
                if(res.ok) {
                    showToast('Email Sent!');
                    document.getElementById('editor').innerHTML = '';
                    document.getElementById('subject').value = '';
                    document.getElementById('recipientEmail').value = '';
                    document.getElementById('fixSpamBtn').classList.add('hidden');
                } else throw new Error();
            } catch(e) {
                showToast('Send failed', 'error');
            } finally {
                btn.innerHTML = oldHtml;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>